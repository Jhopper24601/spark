var sockets = require('./sockets.js');
var screen = require('./screen.js');
var nconf = require('nconf');
var util = require('./util.js');

nconf.argv()
     .env()
     .file({file: '../config.json'});

sockets.setConfig(nconf);
screen.setConfig(nconf);

var ghost_1_1 = [29,29,29, 15,15,44, 41,23,105, 255,15,15, 255,15,15, 41,23,105, 15,15,44, 15,15,15, 36,14,11, 147,153,204, 96,136,255, 255,82,80, 255,82,80, 96,136,255, 147,153,204, 27,3,0, 222,15,15, 255,208,204, 255,255,255, 255,80,80, 255,80,80, 255,255,255, 255,208,204, 209,0,0, 255,15,15, 255,31,31, 255,96,96, 255,0,0, 255,0,0, 255,96,96, 255,31,31, 247,0,0, 255,15,15, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 240,0,0, 255,15,15, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 240,0,0, 255,11,11, 255,0,0, 240,0,0, 255,0,0, 255,0,0, 240,0,0, 255,0,0, 249,0,0, 186,29,29, 227,15,15, 56,15,15, 202,15,15, 202,15,15, 56,15,15, 227,15,15, 176,15,15];
var ghost_1_1_w = 8;
var ghost_1_1_h = 8;

var ghost_1_2 = [0,0,0, 36,0,0, 116,0,0, 255,0,0, 255,0,0, 96,0,0, 0,0,0, 0,0,0, 20,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 227,0,0, 4,0,0, 159,0,0, 255,84,84, 255,195,195, 255,0,0, 255,0,0, 255,223,223, 255,0,0, 32,0,0, 219,0,0, 255,255,255, 255,255,255, 255,32,32, 255,159,159, 255,255,255, 255,223,223, 171,0,0, 255,0,0, 159,118,195, 32,63,243, 255,20,20, 255,99,99, 0,49,255, 255,139,139, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 195,0,0, 195,0,0, 12,0,0, 235,0,0, 156,0,0, 36,0,0, 255,0,0, 116,0,0];
var ghost_1_2_w = 8;
var ghost_1_2_h = 8;

var ghost_1_3 = [0,0,0, 0,0,0, 96,0,0, 255,0,0, 255,0,0, 116,0,0, 36,0,0, 0,0,0, 4,0,0, 227,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 20,0,0, 32,0,0, 255,195,195, 255,84,84, 255,0,0, 255,28,28, 255,223,223, 255,0,0, 159,0,0, 151,16,32, 96,126,255, 255,255,255, 255,0,0, 96,126,255, 235,239,255, 255,96,96, 219,0,0, 235,4,20, 96,114,243, 255,195,195, 255,0,0, 96,43,171, 235,239,255, 255,60,60, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 235,0,0, 12,0,0, 195,0,0, 159,0,0, 32,0,0, 255,0,0, 36,0,0, 156,0,0];
var ghost_1_3_w = 8;
var ghost_1_3_h = 8;

var ghost_1_4 = [0,0,0, 12,0,0, 96,0,0, 255,0,0, 255,0,0, 96,0,0, 12,0,0, 0,0,0, 12,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 12,0,0, 96,0,0, 255,0,0, 255,195,195, 255,84,84, 255,0,0, 255,28,28, 255,223,223, 96,0,0, 195,0,0, 255,32,32, 255,255,255, 96,126,255, 255,0,0, 255,255,255, 116,143,255, 135,47,96, 255,0,0, 255,20,20, 255,243,243, 96,67,195, 255,0,0, 255,171,171, 116,143,255, 195,11,60, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 195,0,0, 12,0,0, 235,0,0, 96,0,0, 96,0,0, 235,0,0, 12,0,0, 195,0,0];
var ghost_1_4_w = 8;
var ghost_1_4_h = 8;


var pac1 = [0,0,0, 0,0,0, 0,0,0, 0,0,0, 77,77,13, 68,68,13, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 75,75,0, 222,222,0, 255,255,0, 255,255,0, 63,63,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 255,255,0, 255,255,0, 124,124,0, 0,0,0, 0,0,0, 0,0,0, 127,127,0, 255,255,0, 252,252,0, 102,102,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 146,146,0, 255,255,0, 251,251,0, 62,62,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 42,42,0, 255,255,0, 255,255,0, 254,254,0, 76,76,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 113,113,0, 255,255,0, 255,255,0, 255,255,0, 64,64,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 59,59,13, 134,134,13, 130,130,13, 0,0,0, 0,0,0];
var pac1_width = 8;
var pac1_height = 8;

var pac2 = [0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 59,59,0, 194,194,0, 242,242,0, 190,190,0, 70,70,0, 0,0,0, 0,0,0, 48,48,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 235,235,0, 0,0,0, 0,0,0, 138,138,0, 255,255,0, 252,252,0, 159,159,0, 62,62,0, 21,21,0, 0,0,0, 0,0,0, 144,144,0, 255,255,0, 251,251,0, 131,131,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 67,67,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 215,215,0, 0,0,0, 0,0,0, 0,0,0, 101,101,0, 239,239,0, 255,255,0, 242,242,0, 127,127,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0];
var pac2_width = 8;
var pac2_height = 8;

var pac3 = [0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 88,88,0, 216,216,0, 242,242,0, 166,166,0, 20,20,0, 0,0,0, 0,0,0, 73,73,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 221,221,0, 0,0,0, 0,0,0, 197,197,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 78,78,13, 0,0,0, 203,203,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 84,84,13, 0,0,0, 102,102,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 251,251,0, 34,34,13, 0,0,0, 0,0,0, 138,138,0, 251,251,0, 255,255,0, 219,219,0, 51,51,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0];
var pac3_width = 8;
var pac3_height = 8;

var count = 0;
var on = true;
var seq = 0;
var col = 0;
var forward = true;
var drawcount = 0;

var drawing = false;

var screens = ["Freddy", "Robot"];
var brightness = 32;

function setup(message) {
  console.log("message in setup: ", message);
  var coreid = JSON.parse(message).coreid
  	screen.setup(coreid, function(){
      console.log("done with setup, setting brightness");
      screen.setBrightness([util.getNameForCoreId(coreid)], brightness, function(bright, err){
        console.log("Screen birghtness set to ", bright);
      });
      if(!drawing)
      {
        console.log("BEGIN DRAW");
        draw();   
        drawing = true;
      }
    });
};

function draw() {
  if(drawcount > 80)
    drawcount = 0;

  console.log("drawing: ", drawcount);
  if(drawcount >= 0 && drawcount < 40)
  {
    drawPac();
  }
  else if(drawcount >= 40 && drawcount <= 80)
  {
    drawGhost();
  }
  // else if(drawcount >= 100 && drawcount <= 200)
  // {
  //   drawInvader();
  // }
  else
  {
    drawcount = 0;
    drawPac();
  }
  drawcount++;
}

function drawGhost() {
  col++;
  if(col > 63)
    col = 0; 

  seq++;
  if(seq > 3)
    seq = 0;

  if(seq == 0)
  {
    screen.drawVBMP(col, 3, function(){
      draw();
    });
  }
  else if(seq == 1)
  {
    screen.drawVBMP(col, 4, function(){
      draw();
    });
  }
  else if(seq == 2)
  {
    screen.drawVBMP(col, 5, function(){
      draw();
    });
  }
  else if(seq == 3)
  {
    screen.drawVBMP(col, 6, function(){
      draw();
    });
  }
};

function drawPac() {
  console.log("drawing pac: ", seq);
  
  col++;
  if(col > 63)
    col = 0; 

  seq++;
  if(seq > 2)
    seq = 0;

  screen.drawVBMP(col, seq, function(){
      draw();
  });
};

function main() {
  screen.addBitmap(pac1, pac1_width, pac1_height, 0);
  screen.addBitmap(pac2, pac2_width, pac2_height, 1);
  screen.addBitmap(pac3, pac3_width, pac3_height, 2);
  screen.addBitmap(ghost_1_1, ghost_1_1_w, ghost_1_1_h, 3);
  screen.addBitmap(ghost_1_2, ghost_1_2_w, ghost_1_2_h, 4);
  screen.addBitmap(ghost_1_3, ghost_1_3_w, ghost_1_3_h, 5);
  screen.addBitmap(ghost_1_4, ghost_1_4_w, ghost_1_4_h, 6);

	sockets.registerListener(function(message){
    console.log("setting up pacman with message ", message);
    setup(message);
  });
};

main();